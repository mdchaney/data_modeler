<!DOCTYPE html>
<html>
<head>
    <title>FK Test</title>
</head>
<body>
    <h1>Foreign Key Test</h1>
    <button onclick="testFK()">Test FK</button>
    <pre id="output"></pre>
    
    <svg id="diagram" style="display: none;">
        <g id="zoom-group">
            <g id="relationships"></g>
            <g id="tables"></g>
        </g>
    </svg>
    
    <script src="js/main.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/data-model.js"></script>
    <script src="js/render-tables.js"></script>
    <script src="js/render-relationships.js"></script>
    <script src="js/interactions.js"></script>
    <script src="js/foreign-keys.js"></script>
    <script src="js/modals.js"></script>
    <script src="js/export.js"></script>
    
    <script>
        function log(msg) {
            document.getElementById('output').textContent += msg + '\n';
        }
        
        function testFK() {
            // Create a simple model with tables and foreign keys
            NModelViewer.state.modelData = {
                ObjectJsons: {}
            };
            
            // Create MVDiagram
            const diagramUUID = 'diagram-123';
            NModelViewer.state.modelData.ObjectJsons[diagramUUID] = [
                {
                    "_META_": true,
                    "ObjectTypeID": "MVDiagram",
                    "ChildObjectUUIDs": ['display-1', 'display-2']
                }
            ];
            NModelViewer.state.mvDiagramUUID = diagramUUID;
            
            // Create table 1
            const table1UUID = 'table-1';
            NModelViewer.state.modelData.ObjectJsons[table1UUID] = [
                {
                    "_META_": true,
                    "ObjectTypeID": "TableNormal_PGSQL",
                    "ObjectName": "users"
                },
                {
                    "TableCommon": {
                        "Fields": [
                            {"Name": "id", "Type": "INTEGER", "IsNull": "NO"}
                        ],
                        "ForeignKeys": []
                    }
                }
            ];
            
            // Create table 2 with FK
            const table2UUID = 'table-2';
            NModelViewer.state.modelData.ObjectJsons[table2UUID] = [
                {
                    "_META_": true,
                    "ObjectTypeID": "TableNormal_PGSQL",
                    "ObjectName": "posts"
                },
                {
                    "TableCommon": {
                        "Fields": [
                            {"Name": "id", "Type": "INTEGER", "IsNull": "NO"},
                            {"Name": "user_id", "Type": "INTEGER", "IsNull": "YES"}
                        ],
                        "ForeignKeys": [
                            {
                                "Name": "fk_posts_users",
                                "Fields": ["user_id"],
                                "ReferenceTable": "users",
                                "ReferenceFields": ["id"]
                            }
                        ]
                    }
                }
            ];
            
            // Create display objects
            NModelViewer.state.modelData.ObjectJsons['display-1'] = [
                {
                    "_META_": true,
                    "ObjectTypeID": "MVDiagramModelObject_Table"
                },
                {"RefUUID": table1UUID}
            ];
            
            NModelViewer.state.modelData.ObjectJsons['display-2'] = [
                {
                    "_META_": true,
                    "ObjectTypeID": "MVDiagramModelObject_Table"
                },
                {"RefUUID": table2UUID}
            ];
            
            log('Created test model with FK');
            
            // Parse the model
            NModelViewer.dataModel.parseAndRenderDiagram();
            
            log('After parsing:');
            log('tablesMap: ' + JSON.stringify(NModelViewer.state.tablesMap, null, 2));
            
            // Now save and check
            log('\nSaving model...');
            
            // Override download to capture saved data
            const originalCreateElement = document.createElement;
            document.createElement = function(tagName) {
                const elem = originalCreateElement.call(document, tagName);
                if (tagName === 'a') {
                    elem.click = function() {
                        fetch(this.href)
                            .then(response => response.text())
                            .then(text => {
                                const saved = JSON.parse(text);
                                log('\nSaved model:');
                                log(JSON.stringify(saved, null, 2));
                                
                                // Check if FK is preserved
                                const savedTable2 = saved.ObjectJsons[table2UUID];
                                if (savedTable2) {
                                    const tableCommon = savedTable2.find(obj => obj.TableCommon);
                                    if (tableCommon && tableCommon.TableCommon.ForeignKeys) {
                                        log('\nForeign keys in saved table2: ' + 
                                            JSON.stringify(tableCommon.TableCommon.ForeignKeys, null, 2));
                                    } else {
                                        log('\nERROR: No foreign keys in saved table2!');
                                    }
                                }
                            });
                    };
                }
                return elem;
            };
            
            NModelViewer.dataModel.saveModel();
            document.createElement = originalCreateElement;
        }
    </script>
</body>
</html>